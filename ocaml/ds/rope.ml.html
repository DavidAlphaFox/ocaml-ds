<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
  <title>
rope.ml</title>
  <meta name="GENERATOR" content="caml2html 1.4.3">
<style type="text/css">
code,pre { color:black;background-color:white }a.Cannot { color:black;text-decoration:none }.Cstring { color: #aa4444; }
.Craise { color: red; }
.Cconstructor { color: #0033cc; }
.Ccomment { color: #990000; }
.Cassert,
.Cinclude,
.Copen { color: #cc9900; }
.Cbar,
.Cdo,
.Cdone,
.Cdownto,
.Celse,
.Cfor,
.Cif,
.Clazy,
.Cmatch,
.Cnew,
.Cor,
.Cthen,
.Cto,
.Ctry,
.Cwhen,
.Cwhile,
.Cwith { color: #77aaaa; }
.Cbegin,
.Cend,
.Cobject,
.Csig,
.Cstruct { color: #990099; }
.Clinenum { color: black; background-color: silver; }
.Cbackground { background-color: white; }
.Cannot:hover { background-color: #b4eeb4; }
.Calphakeyword,
.Casr,
.Cland,
.Clor,
.Clsl,
.Clsr,
.Clxor,
.Cmod { color: #808080; }
.Cfalse,
.Cnonalphakeyword,
.Cquotation,
.Ctrue { }
.Cand,
.Cas,
.Cclass,
.Cconstraint,
.Cexception,
.Cexternal,
.Cfun,
.Cfunction,
.Cfunctor,
.Cin,
.Cinherit,
.Cinitializer,
.Clet,
.Cmethod,
.Cmodule,
.Cmutable,
.Cof,
.Cprivate,
.Crec,
.Ctype,
.Cval,
.Cvirtual { color: green; }
</style>
</head>
<body>

<pre><a name="rope.ml"></a><span class="Ccomment">(**************************************************************************)</span>
<span class="Ccomment">(*                                                                        *)</span>
<span class="Ccomment">(*  Copyright (C) Jean-Christophe Filliatre                               *)</span>
<span class="Ccomment">(*                                                                        *)</span>
<span class="Ccomment">(*  This software is free software; you can redistribute it and/or        *)</span>
<span class="Ccomment">(*  modify it under the terms of the GNU Library General Public           *)</span>
<span class="Ccomment">(*  License version 2.1, with the special exception on linking            *)</span>
<span class="Ccomment">(*  described in file LICENSE.                                            *)</span>
<span class="Ccomment">(*                                                                        *)</span>
<span class="Ccomment">(*  This software is distributed in the hope that it will be useful,      *)</span>
<span class="Ccomment">(*  but WITHOUT ANY WARRANTY; without even the implied warranty of        *)</span>
<span class="Ccomment">(*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                  *)</span>
<span class="Ccomment">(*                                                                        *)</span>
<span class="Ccomment">(**************************************************************************)</span>

<span class="Cexception">exception</span> <span class="Cconstructor">Out_of_bounds</span>

<span class="Cmodule">module</span> <span class="Ctype">type</span> <span class="Cconstructor">STRING</span> <span class="Cnonalphakeyword">=</span> <span class="Csig">sig</span>

  <span class="Ctype">type</span> t

  <span class="Ctype">type</span> char

  <span class="Cval">val</span> length : t <span class="Cnonalphakeyword">-&gt;</span> int

  <span class="Cval">val</span> empty : t
    
  <span class="Cval">val</span> singleton : char <span class="Cnonalphakeyword">-&gt;</span> t
    
  <span class="Cval">val</span> append : t <span class="Cnonalphakeyword">-&gt;</span> t <span class="Cnonalphakeyword">-&gt;</span> t

  <span class="Cval">val</span> get : t <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> char

  <span class="Ccomment">(* [sub t ofs len] *)</span>
  <span class="Cval">val</span> sub : t <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> t

  <span class="Cval">val</span> iter_range : <span class="Cnonalphakeyword">(</span>char <span class="Cnonalphakeyword">-&gt;</span> unit<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> t <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> unit

  <span class="Cval">val</span> print : <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>formatter <span class="Cnonalphakeyword">-&gt;</span> t <span class="Cnonalphakeyword">-&gt;</span> unit

<span class="Cend">end</span>

<span class="Cmodule">module</span> <span class="Ctype">type</span> <span class="Cconstructor">ROPE</span> <span class="Cnonalphakeyword">=</span> <span class="Csig">sig</span>

  <span class="Cinclude">include</span> <span class="Cconstructor">STRING</span>

  <span class="Cval">val</span> set : t <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> char <span class="Cnonalphakeyword">-&gt;</span> t

  <span class="Cval">val</span> delete : t <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> t

  <span class="Cval">val</span> insert_char : t <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> char <span class="Cnonalphakeyword">-&gt;</span> t

  <span class="Cval">val</span> insert : t <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> t <span class="Cnonalphakeyword">-&gt;</span> t

  <span class="Cmodule">module</span> <span class="Cconstructor">Cursor</span> : <span class="Csig">sig</span>

    <span class="Ctype">type</span> cursor
      
    <span class="Cval">val</span> create : t <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> cursor
      
    <span class="Cval">val</span> position : cursor <span class="Cnonalphakeyword">-&gt;</span> int
      
    <span class="Cval">val</span> to_rope : cursor <span class="Cnonalphakeyword">-&gt;</span> t
      
    <span class="Cval">val</span> move_forward : cursor <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> cursor
      
    <span class="Cval">val</span> move_backward : cursor <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> cursor

    <span class="Cval">val</span> move : cursor <span class="Cnonalphakeyword">-&gt;</span> int <span class="Cnonalphakeyword">-&gt;</span> cursor

    <span class="Cval">val</span> get : cursor <span class="Cnonalphakeyword">-&gt;</span> char
      
    <span class="Cval">val</span> set : cursor <span class="Cnonalphakeyword">-&gt;</span> char <span class="Cnonalphakeyword">-&gt;</span> cursor

    <span class="Cval">val</span> insert_char : cursor <span class="Cnonalphakeyword">-&gt;</span> char <span class="Cnonalphakeyword">-&gt;</span> cursor

    <span class="Cval">val</span> insert : cursor <span class="Cnonalphakeyword">-&gt;</span> t <span class="Cnonalphakeyword">-&gt;</span> cursor

<span class="Ccomment">(* NYI</span>
<span class="Ccomment">    val delete : cursor -&gt; cursor</span>
<span class="Ccomment">*)</span>

    <span class="Cval">val</span> print : <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>formatter <span class="Cnonalphakeyword">-&gt;</span> cursor <span class="Cnonalphakeyword">-&gt;</span> unit

  <span class="Cend">end</span>

<span class="Cend">end</span>

<span class="Cmodule">module</span> <span class="Ctype">type</span> <span class="Cconstructor">CONTROL</span> <span class="Cnonalphakeyword">=</span> <span class="Csig">sig</span>

  <span class="Cval">val</span> small_length : int

  <span class="Cval">val</span> maximal_height : int

<span class="Cend">end</span> 

<span class="Cmodule">module</span> <span class="Cconstructor">Make</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">S</span> : <span class="Cconstructor">STRING</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">C</span> : <span class="Cconstructor">CONTROL</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cstruct">struct</span>

  <span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> 
    <span class="Ccomment">(* s,ofs,len with 0 &lt;= ofs &lt; len(s), ofs+len &lt;= len(s) *)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cof">of</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>t <span class="Cnonalphakeyword">*</span> int <span class="Cnonalphakeyword">*</span> int 
    <span class="Ccomment">(* t1,t2,len,height with 0 &lt; len t1, len t2 *)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> t <span class="Cnonalphakeyword">*</span> int <span class="Cnonalphakeyword">*</span> int  

  <span class="Ctype">type</span> char <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>char

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">empty</a> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>empty</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">)</span> 
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; t">of_string</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; t">singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; t">of_string</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">height</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">h</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">h</a>

  <span class="Ccomment">(* smart constructor *)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">mk_app</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a> <span class="Cnonalphakeyword">=</span> 
    <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">max</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">height</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">height</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span> 
        <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cconstructor">C</span><span class="Cnonalphakeyword">.</span>small_length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool"><span class="Cnonalphakeyword">&amp;&amp;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cconstructor">C</span><span class="Cnonalphakeyword">.</span>small_length</a> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Cconstructor">Str</span> 
          <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; S.t -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>append</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; int -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; int -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span>
        <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cconstructor">C</span><span class="Cnonalphakeyword">.</span>small_length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool"><span class="Cnonalphakeyword">&amp;&amp;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cconstructor">C</span><span class="Cnonalphakeyword">.</span>small_length</a> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> 
             <span class="Cconstructor">Str</span> 
               <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; S.t -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>append</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; int -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; int -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> 
                <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
             <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">,</span>
             <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">height</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span>
        <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cconstructor">C</span><span class="Cnonalphakeyword">.</span>small_length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool"><span class="Cnonalphakeyword">&amp;&amp;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cconstructor">C</span><span class="Cnonalphakeyword">.</span>small_length</a> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> 
               <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; S.t -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>append</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; int -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; int -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> 
                <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span>
             <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> 
             <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len2</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span>
             <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">height</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">max</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">height</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">height</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">append</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t"><span class="Cnonalphakeyword">(</span>++<span class="Cnonalphakeyword">)</span></a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">append</a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t">balance</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cnonalphakeyword">=</span>
    <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int * t list -&gt; t -&gt; int * t list">to_list</a> <span class="Cnonalphakeyword">(</span><span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a><span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> acc<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a> <span class="Cas">as</span> x <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">x</a> <span class="Cnonalphakeyword">::</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a>
      <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int * t list -&gt; t -&gt; int * t list">to_list</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int * t list -&gt; t -&gt; int * t list">to_list</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int * t list">acc</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a>
    <span class="Cin">in</span>
    <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t list -&gt; t * t list">build</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cnonalphakeyword">=</span> 
      <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&gt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
      <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <span class="Cthen">then</span> <span class="Cbegin">begin</span>
        <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cwith">with</span>
          <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list"><span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span></a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t list"><span class="Cassert">assert</span> <span class="Cfalse">false</span></a>
          <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">x</a> <span class="Cnonalphakeyword">::</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">r</a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">x</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">r</a>
      <span class="Cend">end</span> <span class="Celse">else</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n'</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">/</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">2</a> <span class="Cin">in</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t list -&gt; t * t list">build</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n'</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cin">in</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t list -&gt; t * t list">build</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n'</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cin">in</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">mk_app</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a>
    <span class="Cin">in</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int * t list -&gt; t -&gt; int * t list">to_list</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list"><span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span></a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cin">in</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t list -&gt; t * t list">build</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <span class="Cin">in</span>
    <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list">l</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list -&gt; t list -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t list"><span class="Cnonalphakeyword">[</span><span class="Cnonalphakeyword">]</span></a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a>

  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; S.char">unsafe_get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; S.char"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; S.char">unsafe_get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; S.char">unsafe_get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; S.char">get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> 
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&gt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; S.char">unsafe_get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a>

  <span class="Ccomment">(* assumption: 0 &lt;= start &lt; stop &lt;= len(t) *)</span>
  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; t -&gt; t">mksub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">start</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cnonalphakeyword">=</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">start</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool"><span class="Cnonalphakeyword">&amp;&amp;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cthen">then</span>
      <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> 
    <span class="Celse">else</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cwith">with</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
          <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">start</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">start</a><span class="Cnonalphakeyword">)</span>
      <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <span class="Cin">in</span>
          <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; t -&gt; t">mksub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">start</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> 
          <span class="Celse">else</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">start</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&gt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; t -&gt; t">mksub</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">start</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a>
          <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; t -&gt; t">mksub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">start</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; t -&gt; t">mksub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; int -&gt; t">sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cnonalphakeyword">=</span> 
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cin">in</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&gt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">empty</a> <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; t -&gt; t">mksub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">stop</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a>

  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(S.char -&gt; unit) -&gt; int -&gt; int -&gt; t -&gt; unit">safe_iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; unit">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(S.char -&gt; unit) -&gt; S.t -&gt; int -&gt; int -&gt; unit"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; unit">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(S.char -&gt; unit) -&gt; int -&gt; int -&gt; t -&gt; unit">safe_iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; unit">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a>
        <span class="Celse">else</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&gt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(S.char -&gt; unit) -&gt; int -&gt; int -&gt; t -&gt; unit">safe_iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; unit">f</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a>
        <span class="Celse">else</span> <span class="Cbegin">begin</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(S.char -&gt; unit) -&gt; int -&gt; int -&gt; t -&gt; unit">safe_iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; unit">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">;</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(S.char -&gt; unit) -&gt; int -&gt; int -&gt; t -&gt; unit">safe_iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; unit">f</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a> 
        <span class="Cend">end</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(S.char -&gt; unit) -&gt; t -&gt; int -&gt; int -&gt; unit">iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; unit">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cnonalphakeyword">=</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&gt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(S.char -&gt; unit) -&gt; int -&gt; int -&gt; t -&gt; unit">safe_iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; unit">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a>

  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; t -&gt; unit">print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; S.t -&gt; unit"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; int -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* TODO: IMPROVE? *)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; t -&gt; unit">print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; t -&gt; unit">print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a>

  <span class="Ccomment">(* assumption: 0 &lt;= i &lt; len t *)</span>
  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; S.char -&gt; t -&gt; t">set_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cnonalphakeyword">-&gt;</span> 
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; t">singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a> <span class="Cnonalphakeyword">-&gt;</span> 
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; t">singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; t">singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; S.char -&gt; t -&gt; t">set_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span> 
        <span class="Celse">else</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; S.char -&gt; t -&gt; t">set_rec</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span>

  <span class="Ccomment">(* set t i c = sub t 0 i ++ singleton c ++ sub t (i+1) (length t-i-1) *)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; S.char -&gt; t">set</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a> <span class="Cnonalphakeyword">=</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cin">in</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&gt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; S.char -&gt; t -&gt; t">set_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a>

  <span class="Ccomment">(* assumption: 0 &lt;= i &lt; len t *)</span>
  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t -&gt; t">delete_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">empty</a>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t -&gt; t">delete_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span> 
        <span class="Celse">else</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t -&gt; t">delete_rec</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span>

  <span class="Ccomment">(* delete t i = sub t 0 i ++ sub t (i + 1) (length t - i - 1) *)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; t">delete</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cin">in</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&gt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t -&gt; t">delete_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a>

  <span class="Ccomment">(* assumption: 0 &lt;= i &lt; len t *)</span>
  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t -&gt; t -&gt; t">insert_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a> <span class="Cas">as</span> s <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cnonalphakeyword">-&gt;</span> 
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">s</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> s <span class="Cwhen">when</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cnonalphakeyword">-&gt;</span> 
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">++</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">++</a> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t -&gt; t -&gt; t">insert_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span> 
        <span class="Celse">else</span> 
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t -&gt; t -&gt; t">insert_rec</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span>

  <span class="Ccomment">(* insert t i r = sub t 0 i ++ r ++ sub t i (length t - i) *)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; t -&gt; t">insert</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <span class="Cnonalphakeyword">=</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cin">in</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&gt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; t -&gt; t -&gt; t">insert_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; S.char -&gt; t">insert_char</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a> <span class="Cnonalphakeyword">=</span> 
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; t -&gt; t">insert</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; t">singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">c</a><span class="Cnonalphakeyword">)</span>

  <span class="Ccomment">(* cursors *)</span>
  <span class="Cmodule">module</span> <span class="Cconstructor">Cursor</span> <span class="Cnonalphakeyword">=</span> <span class="Cstruct">struct</span>

  <span class="Ctype">type</span> path <span class="Cnonalphakeyword">=</span> 
    <span class="Cbar">|</span> <span class="Cconstructor">Top</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Left</span> <span class="Cof">of</span> path <span class="Cnonalphakeyword">*</span> t
    <span class="Cbar">|</span> <span class="Cconstructor">Right</span> <span class="Cof">of</span> t <span class="Cnonalphakeyword">*</span> path

  <span class="Ctype">type</span> cursor <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">{</span>
    rpos: int<span class="Cnonalphakeyword">;</span>    <span class="Ccomment">(* position of the cursor relative to the current leaf *)</span>
    lofs: int<span class="Cnonalphakeyword">;</span>    <span class="Ccomment">(* offset of the current leaf wrt whole rope *)</span>
    leaf: t<span class="Cnonalphakeyword">;</span>      <span class="Ccomment">(* the leaf i.e. Str (s,ofs,len) *)</span>
    path: path<span class="Cnonalphakeyword">;</span>   <span class="Ccomment">(* context = zipper *)</span>
  <span class="Cnonalphakeyword">}</span>
  <span class="Ccomment">(* INVARIANT: 0 &lt;= rpos &lt;= len </span>
<span class="Ccomment">                rpos = len iff we are located at the end of the whole rope *)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int">position</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>rpos

  <span class="Ccomment">(* cursor -&gt; rope *)</span>
  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; t">unzip</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path"><span class="Cconstructor">Top</span></a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a>
    <span class="Cbar">|</span> <span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">tr</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; t">unzip</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">tr</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a>
    <span class="Cbar">|</span> <span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">tl</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; t">unzip</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t * t -&gt; t">app</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">tl</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a>
        
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; t">to_rope</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span> 
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; t">unzip</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; cursor">create</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span>
    <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; path -&gt; t -&gt; cursor">zip</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> leaf  <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Cassert">assert</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool"><span class="Cnonalphakeyword">&amp;&amp;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&lt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
          <span class="Cnonalphakeyword">{</span> rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a><span class="Cnonalphakeyword">;</span> lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a><span class="Cnonalphakeyword">;</span> leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a><span class="Cnonalphakeyword">;</span> path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">}</span>
      <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
          <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <span class="Cin">in</span>
          <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span>
            <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; path -&gt; t -&gt; cursor">zip</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a>
          <span class="Celse">else</span>
            <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; path -&gt; t -&gt; cursor">zip</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a>
    <span class="Cin">in</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="bool -&gt; bool -&gt; bool">||</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&gt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; path -&gt; t -&gt; cursor">zip</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path"><span class="Cconstructor">Top</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; S.char">get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>rpos <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; int -&gt; S.char"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a> <span class="Cnonalphakeyword">-&gt;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char"><span class="Cassert">assert</span> <span class="Cfalse">false</span></a>
 
  <span class="Ccomment">(* TODO: improve using concatenations when lengths &lt;= small_length *)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; S.char -&gt; cursor">set</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">x</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>rpos <span class="Cin">in</span>
         <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">x</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span>
          <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <span class="Cthen">then</span>
            <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a> <span class="Cnonalphakeyword">}</span>
          <span class="Celse">else</span>
            <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> 
                leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a><span class="Cnonalphakeyword">;</span> 
                path <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path<span class="Cnonalphakeyword">,</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
        <span class="Celse">else</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <span class="Cthen">then</span>
          <span class="Cnonalphakeyword">{</span> lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">;</span>
            rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">;</span>
            leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a><span class="Cnonalphakeyword">;</span>
            path <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
        <span class="Celse">else</span> 
          <span class="Cnonalphakeyword">{</span> lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">;</span>
            rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">;</span>
            leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a><span class="Cnonalphakeyword">;</span>
            path <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> 
                         <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a> <span class="Cnonalphakeyword">-&gt;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor"><span class="Cassert">assert</span> <span class="Cfalse">false</span></a>

  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; path -&gt; path">concat_path</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p2</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p1</a> <span class="Cwith">with</span>
    <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path"><span class="Cconstructor">Top</span></a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p2</a>
    <span class="Cbar">|</span> <span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; path -&gt; path">concat_path</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">l</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">l</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; path -&gt; path">concat_path</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p2</a><span class="Cnonalphakeyword">)</span>
 
  <span class="Ccomment">(* TODO: improve using concatenations when lengths &lt;= small_length *)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; t -&gt; cursor">insert</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>rpos <span class="Cin">in</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">cr</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; cursor">create</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span>
          <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">cr</a> <span class="Cwith">with</span> 
              lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs<span class="Cnonalphakeyword">;</span>
              path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; path -&gt; path">concat_path</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">cr</a><span class="Cnonalphakeyword">.</span>path <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path<span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
        <span class="Celse">else</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cthen">then</span>
          <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">cr</a> <span class="Cwith">with</span>
              lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">;</span>
              path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; path -&gt; path">concat_path</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">cr</a><span class="Cnonalphakeyword">.</span>path <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf<span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
        <span class="Celse">else</span> 
          <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">cr</a> <span class="Cwith">with</span>
              lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">;</span>
              path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; path -&gt; path">concat_path</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">cr</a><span class="Cnonalphakeyword">.</span>path 
                       <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path<span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> 
                              <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a> <span class="Cnonalphakeyword">-&gt;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor"><span class="Cassert">assert</span> <span class="Cfalse">false</span></a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; S.char -&gt; cursor">insert_char</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">x</a> <span class="Cnonalphakeyword">=</span> 
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; t -&gt; cursor">insert</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t -&gt; t">of_string</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char -&gt; S.t"><span class="Cconstructor">S</span><span class="Cnonalphakeyword">.</span>singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.char">x</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
 
  <span class="Ccomment">(* moves to start of next leaf (on the right) if any, </span>
<span class="Ccomment">     or raises [Out_of_bounds] *)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; cursor">next_leaf</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <span class="Cin">in</span>
    <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; t -&gt; cursor">down</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a> <span class="Cas">as</span> leaf <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">{</span> rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">;</span> lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a><span class="Cnonalphakeyword">;</span> leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a><span class="Cnonalphakeyword">;</span> path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">}</span>
      <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; t -&gt; cursor">down</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a>
    <span class="Cin">in</span>
    <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; cursor">up</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
      <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path"><span class="Cconstructor">Top</span></a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; cursor">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a>
      <span class="Cbar">|</span> <span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">l</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; cursor">up</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">mk_app</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">l</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a>
      <span class="Cbar">|</span> <span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; t -&gt; cursor">down</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a>
    <span class="Cin">in</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; cursor">up</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path

  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_forward_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>rpos <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cthen">then</span>
          <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <span class="Cnonalphakeyword">}</span>
        <span class="Celse">else</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cthen">then</span> <span class="Cbegin">begin</span> 
          <span class="Ctry">try</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; cursor">next_leaf</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <span class="Cnonalphakeyword">}</span> 
        <span class="Cend">end</span> <span class="Celse">else</span> <span class="Ccomment">(* rpos' &gt; len *)</span>
          <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; cursor">next_leaf</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cin">in</span>
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_forward_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Ccomment">(* TODO: IMPROVE? *)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a> <span class="Cnonalphakeyword">-&gt;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor"><span class="Cassert">assert</span> <span class="Cfalse">false</span></a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_forward</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; unit">invalid_arg</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string"><span class="Cstring">"Rop.move_forward"</span></a><span class="Cnonalphakeyword">;</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_forward_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a>

  <span class="Ccomment">(* moves to the end of previous leaf (on the left) if any,</span>
<span class="Ccomment">     raises [Out_of_bounds] otherwise *)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; cursor">prev_leaf</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span>
    <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; t -&gt; cursor">down</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
      <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cas">as</span> leaf <span class="Cnonalphakeyword">-&gt;</span> 
          <span class="Cnonalphakeyword">{</span> rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">;</span> lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">;</span> leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a><span class="Cnonalphakeyword">;</span> path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">}</span>
      <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; t -&gt; cursor">down</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a>
    <span class="Cin">in</span>
    <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; cursor">up</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
      <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path"><span class="Cconstructor">Top</span></a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; cursor">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a>
      <span class="Cbar">|</span> <span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">l</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path -&gt; t -&gt; cursor">down</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">l</a>
      <span class="Cbar">|</span> <span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; cursor">up</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">mk_app</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a>
    <span class="Cin">in</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; path -&gt; cursor">up</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path

  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_backward_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>rpos <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cin">in</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool">&gt;=</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span>
          <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a> <span class="Cnonalphakeyword">}</span>
        <span class="Celse">else</span> <span class="Ccomment">(* rpos' &lt; 0 *)</span>
          <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; cursor">prev_leaf</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cin">in</span>
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_backward_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">rpos'</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a> <span class="Cnonalphakeyword">-&gt;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor"><span class="Cassert">assert</span> <span class="Cfalse">false</span></a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_backward</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; unit">invalid_arg</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string"><span class="Cstring">"Rop.move_backward"</span></a><span class="Cnonalphakeyword">;</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_backward_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <span class="Cnonalphakeyword">=</span>
    <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> 
    <span class="Celse">else</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&gt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_forward_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a>
    <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int -&gt; cursor">move_backward_rec</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int"><span class="Cnonalphakeyword">-</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">)</span>
      
  <span class="Clet">let</span> <span class="Crec">rec</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; path -&gt; t -&gt; cursor">leftmost</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t"><span class="Cnonalphakeyword">_</span></a> <span class="Cas">as</span> leaf <span class="Cnonalphakeyword">-&gt;</span> <span class="Cnonalphakeyword">{</span> rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">;</span> lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a><span class="Cnonalphakeyword">;</span> leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">leaf</a><span class="Cnonalphakeyword">;</span> path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">}</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; path -&gt; t -&gt; cursor">leftmost</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">lofs</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; cursor">delete</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>leaf <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>rpos <span class="Cin">in</span>
         <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn -&gt; unit">raise</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="exn"><span class="Cconstructor">Out_of_bounds</span></a><span class="Cnonalphakeyword">;</span>
        <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cthen">then</span>
          <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <span class="Cthen">then</span> <span class="Cbegin">begin</span>
            <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path <span class="Cwith">with</span>
              <span class="Cbar">|</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path"><span class="Cconstructor">Top</span></a> <span class="Cnonalphakeyword">-&gt;</span> 
                  <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">empty</a> <span class="Cnonalphakeyword">}</span>
              <span class="Cbar">|</span> <span class="Cconstructor">Left</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
                  <span class="Ccomment">(* leftmost c.lofs p r *)</span>
                  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; t">to_rope</a> <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">;</span> path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">}</span> <span class="Cin">in</span> 
                  <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; cursor">create</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs
              <span class="Cbar">|</span> <span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Ccomment">(* TODO: IMPROVE *)</span>
                  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; t">to_rope</a> <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> leaf <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a><span class="Cnonalphakeyword">;</span> path <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="path">p</a> <span class="Cnonalphakeyword">}</span> <span class="Cin">in</span> 
                  <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; cursor">create</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs
          <span class="Cend">end</span> <span class="Celse">else</span>
            <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> leaf <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
        <span class="Celse">else</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">=</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <span class="Cthen">then</span>
          <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; cursor">next_leaf</a> <span class="Cnonalphakeyword">{</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cwith">with</span> leaf <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
        <span class="Celse">else</span>
          <span class="Cnonalphakeyword">{</span> lofs <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>lofs <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">;</span>
            rpos <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a><span class="Cnonalphakeyword">;</span>
            leaf <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">;</span>
            path <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Right</span> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="S.t">s</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a><span class="Cnonalphakeyword">.</span>path<span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">}</span>
    <span class="Cbar">|</span> <span class="Cconstructor">App</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t"><span class="Cnonalphakeyword">_</span></a> <span class="Cnonalphakeyword">-&gt;</span>
        <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor"><span class="Cassert">assert</span> <span class="Cfalse">false</span></a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; cursor -&gt; unit">print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* TODO: improve *)</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; t">to_rope</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cin">in</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor -&gt; int">position</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="cursor">c</a> <span class="Cin">in</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">before</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; int -&gt; t">sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cin">in</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">after</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; int -&gt; t">sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">r</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <span class="Cin">in</span>
    <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; t -&gt; unit">print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">before</a><span class="Cnonalphakeyword">;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; (unit, Format.formatter, unit) format -&gt; unit"><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>fprintf</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(unit, Format.formatter, unit) format"><span class="Cstring">"|"</span></a><span class="Cnonalphakeyword">;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; t -&gt; unit">print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">after</a>

  <span class="Cend">end</span> <span class="Ccomment">(* Cursor *)</span>

<span class="Cend">end</span>

<span class="Ccomment">(********</span>
<span class="Ccomment"></span>
<span class="Ccomment">(* cursors *)</span>
<span class="Ccomment"></span>
<span class="Ccomment">type path = </span>
<span class="Ccomment">  | Top</span>
<span class="Ccomment">  | Left of path * t</span>
<span class="Ccomment">  | Right of t * path</span>
<span class="Ccomment"></span>
<span class="Ccomment">type cursor = {</span>
<span class="Ccomment">  pos : int;    (* position of the cursor *)</span>
<span class="Ccomment">  lofs: int;    (* offset of the current leaf *)</span>
<span class="Ccomment">  leaf: t;      (* the leaf i.e. Str (str,ofs,len) *)</span>
<span class="Ccomment">  path: path;   (* context = zipper *)</span>
<span class="Ccomment">}</span>
<span class="Ccomment"></span>
<span class="Ccomment">(* cursor -&gt; rope *)</span>
<span class="Ccomment">let rec unzip t = function</span>
<span class="Ccomment">  | Top -&gt; t</span>
<span class="Ccomment">  | Left (p, tr) -&gt; unzip (mk_app t tr) p</span>
<span class="Ccomment">  | Right (tl, p) -&gt; unzip (mk_app tl t) p</span>
<span class="Ccomment"></span>
<span class="Ccomment">let rope_of_cursor pos = </span>
<span class="Ccomment">  unzip pos.leaf pos.path</span>
<span class="Ccomment"></span>
<span class="Ccomment">let rec zip_leftmost p = function</span>
<span class="Ccomment">  | Str _ as leaf -&gt; { pos = 0; lofs = 0; leaf = leaf; path = p }</span>
<span class="Ccomment">  | App (t1, t2, _, _) -&gt; zip_leftmost (Left (p, t2)) t1</span>
<span class="Ccomment"></span>
<span class="Ccomment">let start = zip_leftmost Top</span>
<span class="Ccomment"></span>
<span class="Ccomment">let cursor_at_start c = c.pos = 0</span>
<span class="Ccomment"></span>
<span class="Ccomment">let rec cursor_pop = function</span>
<span class="Ccomment">  | { pos = 0; lofs = 0; leaf = Str (s, ofs, 1); path = p } as c -&gt;</span>
<span class="Ccomment">      String.unsafe_get s ofs, </span>
<span class="Ccomment">      begin match p with</span>
<span class="Ccomment"></span>        <span class="Ccomment">| Top -&gt; { c with leaf = empty; path = Top }</span>
<span class="Ccomment"></span>        <span class="Ccomment">| Left (p, r) -&gt; zip_leftmost p r</span>
<span class="Ccomment"></span>        <span class="Ccomment">| Right _ -&gt; assert false</span>
<span class="Ccomment">      end</span>
<span class="Ccomment">  | { pos = 0; lofs = 0; leaf = Str (_, _, 0); path = p } -&gt;</span>
<span class="Ccomment">      assert (p = Top);</span>
<span class="Ccomment">      raise Not_found</span>
<span class="Ccomment">  | { pos = 0; lofs = 0; leaf = Str (s, ofs, len) } as c -&gt;</span>
<span class="Ccomment">      String.unsafe_get s ofs, </span>
<span class="Ccomment">      { c with leaf = Str (s, ofs+1, len-1) }</span>
<span class="Ccomment">  | _ -&gt;</span>
<span class="Ccomment">      assert false</span>
<span class="Ccomment"></span>
<span class="Ccomment">let moveto r i =</span>
<span class="Ccomment">  let rec zip lofs p = function</span>
<span class="Ccomment">    | Str (_, _, len) as leaf when lofs &lt;= i &amp;&amp; i &lt; lofs+len -&gt;</span>
<span class="Ccomment"></span>        <span class="Ccomment">{ pos = i; lofs = lofs; leaf = leaf; path = p }</span>
<span class="Ccomment">    | Str _ -&gt;</span>
<span class="Ccomment"></span>        <span class="Ccomment">Format.eprintf "len(r) = %d lofs = %d i = %d@." (len r) lofs i;</span>
<span class="Ccomment"></span>        <span class="Ccomment">assert false</span>
<span class="Ccomment">    | App (t1, t2, _, _) -&gt;</span>
<span class="Ccomment"></span>        <span class="Ccomment">let n1 = len t1 in</span>
<span class="Ccomment"></span>        <span class="Ccomment">if i &lt; lofs + n1 then</span>
<span class="Ccomment"></span>        <span class="Ccomment">  zip lofs (Left (p, t2)) t1</span>
<span class="Ccomment"></span>        <span class="Ccomment">else</span>
<span class="Ccomment"></span>        <span class="Ccomment">  zip (lofs + n1) (Right (t1, p)) t2</span>
<span class="Ccomment">  in</span>
<span class="Ccomment">  zip 0 Top r</span>
<span class="Ccomment"></span>
<span class="Ccomment">let cursor_get_or_exit c i = match c with</span>
<span class="Ccomment">  | { lofs = lofs; leaf = Str (s, ofs, len) } when lofs &lt;= i &amp;&amp; i &lt; lofs+len -&gt;</span>
<span class="Ccomment">      String.unsafe_get s (ofs + i - lofs)</span>
<span class="Ccomment">  | _ -&gt;</span>
<span class="Ccomment">      raise Exit</span>
<span class="Ccomment"></span>
<span class="Ccomment">let rec cursor_get c i = match c with</span>
<span class="Ccomment">  | { lofs = lofs; leaf = Str (s, ofs, len) } when lofs &lt;= i &amp;&amp; i &lt; lofs+len -&gt;</span>
<span class="Ccomment">      String.unsafe_get s (ofs + i - lofs)</span>
<span class="Ccomment">  | { lofs = lofs; leaf = Str (_, _, ls); path = p } -&gt;</span>
<span class="Ccomment">      let rec lookup_rope lofs ls = function</span>
<span class="Ccomment"></span>        <span class="Ccomment">| Top -&gt; </span>
<span class="Ccomment"></span>        <span class="Ccomment">    raise Not_found</span>
<span class="Ccomment"></span>        <span class="Ccomment">| Left (p, r) -&gt;</span>
<span class="Ccomment"></span>        <span class="Ccomment">    let j = i - (lofs + ls) in</span>
<span class="Ccomment"></span>        <span class="Ccomment">    let lr = len r in</span>
<span class="Ccomment"></span>        <span class="Ccomment">    if 0 &lt;= j &amp;&amp; j &lt; lr then get r j else lookup_rope lofs (ls+lr) p</span>
<span class="Ccomment"></span>        <span class="Ccomment">| Right (l, p) -&gt;</span>
<span class="Ccomment"></span>        <span class="Ccomment">    let ll = len l in</span>
<span class="Ccomment"></span>        <span class="Ccomment">    let llofs = lofs - ll in</span>
<span class="Ccomment"></span>        <span class="Ccomment">    let j = i - llofs in</span>
<span class="Ccomment"></span>        <span class="Ccomment">    if 0 &lt;= j &amp;&amp; j &lt; ll then get l j else lookup_rope llofs (ll+ls) p</span>
<span class="Ccomment">      in</span>
<span class="Ccomment">      lookup_rope lofs ls p</span>
<span class="Ccomment">  | _ -&gt;</span>
<span class="Ccomment">      assert false</span>
<span class="Ccomment"></span>
<span class="Ccomment">*****)</span>

<span class="Ccomment">(* flat strings *)</span>
<span class="Cmodule">module</span> <span class="Cconstructor">Str</span> <span class="Cnonalphakeyword">=</span> <span class="Cstruct">struct</span>
  <span class="Cinclude">include</span> <span class="Cconstructor">String</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; int -&gt; char">get</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; int -&gt; char">unsafe_get</a>
  <span class="Ctype">type</span> char <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Char</span><span class="Cnonalphakeyword">.</span>t
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">empty</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string"><span class="Cstring">""</span></a>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char -&gt; string">singleton</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char -&gt; string"><span class="Cconstructor">String</span><span class="Cnonalphakeyword">.</span>make</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; string -&gt; string">append</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; string -&gt; string"><span class="Cnonalphakeyword">(</span>^<span class="Cnonalphakeyword">)</span></a>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; string -&gt; unit">print</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; string -&gt; unit"><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>pp_print_string</a>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(char -&gt; 'a) -&gt; string -&gt; int -&gt; int -&gt; unit">iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char -&gt; 'a">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cnonalphakeyword">=</span> <span class="Ccomment">(* safe *)</span>
    <span class="Cfor">for</span> i <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <span class="Cto">to</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a> <span class="Cdo">do</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char -&gt; 'a">f</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; int -&gt; char"><span class="Cconstructor">String</span><span class="Cnonalphakeyword">.</span>unsafe_get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <span class="Cdone">done</span>
<span class="Cend">end</span>

<span class="Cmodule">module</span> <span class="Cconstructor">Control</span> <span class="Cnonalphakeyword">=</span> <span class="Cstruct">struct</span> <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">small_length</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">256</a> <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">maximal_height</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">max_int</a> <span class="Cend">end</span>
<span class="Cmodule">module</span> <span class="Cconstructor">S</span> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Make</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Str</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Control</span><span class="Cnonalphakeyword">)</span>


<span class="Ccomment">(* ropes with function leaves *)</span>
<span class="Cmodule">module</span> <span class="Cconstructor">SorF</span> <span class="Cnonalphakeyword">=</span> 
<span class="Cstruct">struct</span>
  <span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">S</span> <span class="Cof">of</span> string <span class="Cbar">|</span> <span class="Cconstructor">F</span> <span class="Cof">of</span> int <span class="Cnonalphakeyword">*</span> <span class="Cnonalphakeyword">(</span>int <span class="Cnonalphakeyword">-&gt;</span> char<span class="Cnonalphakeyword">)</span>
  <span class="Ctype">type</span> char <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">Char</span><span class="Cnonalphakeyword">.</span>t
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int">length</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; int"><span class="Cconstructor">String</span><span class="Cnonalphakeyword">.</span>length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <span class="Cbar">|</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">empty</a> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string"><span class="Cstring">""</span></a>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char -&gt; t">singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char">c</a> <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">S</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char -&gt; string"><span class="Cconstructor">String</span><span class="Cnonalphakeyword">.</span>make</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char">c</a><span class="Cnonalphakeyword">)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; t -&gt; t">append</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t2</a> <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s1</a><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s2</a> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; string -&gt; string">^</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s2</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s1</a><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f2</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> 
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; int"><span class="Cconstructor">String</span><span class="Cnonalphakeyword">.</span>length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s1</a> <span class="Cin">in</span>
        <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n2</a><span class="Cnonalphakeyword">,</span> <span class="Cfun">fun</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s1</a><span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">[</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">]</span> <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f2</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s2</a> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n2</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; int"><span class="Cconstructor">String</span><span class="Cnonalphakeyword">.</span>length</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s2</a> <span class="Cin">in</span>
        <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n2</a><span class="Cnonalphakeyword">,</span> <span class="Cfun">fun</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s2</a><span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">[</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">]</span><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">,</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n2</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f2</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span>
        <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n2</a><span class="Cnonalphakeyword">,</span> <span class="Cfun">fun</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cif">if</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; bool"><span class="Cnonalphakeyword">&lt;</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a> <span class="Cthen">then</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f1</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Celse">else</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f2</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n1</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; char">get</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cwith">with</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a><span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">[</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">]</span> <span class="Cbar">|</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t -&gt; int -&gt; int -&gt; t">sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">S</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; int -&gt; int -&gt; string"><span class="Cconstructor">String</span><span class="Cnonalphakeyword">.</span>sub</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">)</span>
    <span class="Cbar">|</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><span class="Cnonalphakeyword">,</span> <span class="Cfun">fun</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">-</span></a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(char -&gt; 'a) -&gt; t -&gt; int -&gt; int -&gt; unit">iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char -&gt; 'a">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cnonalphakeyword">=</span> <span class="Cmatch">match</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="t">t</a> <span class="Cwith">with</span>
    <span class="Cbar">|</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfor">for</span> i <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <span class="Cto">to</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a> <span class="Cdo">do</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char -&gt; 'a">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a><span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">[</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">]</span> <span class="Cdone">done</span>
    <span class="Cbar">|</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int"><span class="Cnonalphakeyword">_</span></a><span class="Cnonalphakeyword">,</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">fs</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfor">for</span> i <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <span class="Cto">to</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a> <span class="Cdo">do</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="char -&gt; 'a">f</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">fs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <span class="Cdone">done</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; t -&gt; unit">print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <span class="Cnonalphakeyword">=</span> <span class="Cfunction">function</span>
    <span class="Cbar">|</span> <span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <span class="Cnonalphakeyword">-&gt;</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; string -&gt; unit"><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>pp_print_string</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a>
    <span class="Cbar">|</span> <span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f</a><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">-&gt;</span> <span class="Cfor">for</span> i <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">0</a> <span class="Cto">to</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a> <span class="Cdo">do</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; (char -&gt; unit, Format.formatter, unit) format -&gt; char -&gt; unit"><span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>fprintf</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(char -&gt; unit, Format.formatter, unit) format"><span class="Cstring">"%c"</span></a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <span class="Cdone">done</span>
<span class="Cend">end</span>
<span class="Cmodule">module</span> <span class="Cconstructor">SF</span> <span class="Cnonalphakeyword">=</span>
<span class="Cstruct">struct</span>
  <span class="Cmodule">module</span> <span class="Cconstructor">Ctrl</span> <span class="Cnonalphakeyword">=</span> <span class="Cstruct">struct</span> <span class="Cend">end</span>
  <span class="Cinclude">include</span> <span class="Cconstructor">Make</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">SorF</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">Control</span><span class="Cnonalphakeyword">)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; (int -&gt; char) -&gt; t">of_function</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="SorF.t -&gt; t">of_string</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">SorF</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">F</span> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a><span class="Cnonalphakeyword">,</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; char">f</a><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">)</span>
  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string -&gt; t">of_string</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="SorF.t -&gt; t">of_string</a> <span class="Cnonalphakeyword">(</span><span class="Cconstructor">SorF</span><span class="Cnonalphakeyword">.</span><span class="Cconstructor">S</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="string">s</a><span class="Cnonalphakeyword">)</span>
<span class="Cend">end</span>


<span class="Ccomment">(* ropes of any type (using arrays as flat sequences) *)</span>

<span class="Cmodule">module</span> <span class="Ctype">type</span> <span class="Cconstructor">PrintableType</span> <span class="Cnonalphakeyword">=</span> <span class="Csig">sig</span> 
  <span class="Ctype">type</span> t
  <span class="Cval">val</span> print : <span class="Cconstructor">Format</span><span class="Cnonalphakeyword">.</span>formatter <span class="Cnonalphakeyword">-&gt;</span> t <span class="Cnonalphakeyword">-&gt;</span> unit 
<span class="Cend">end</span>

<span class="Cmodule">module</span> <span class="Cconstructor">MakeArray</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">X</span> : <span class="Cconstructor">PrintableType</span><span class="Cnonalphakeyword">)</span> <span class="Cnonalphakeyword">=</span> <span class="Cstruct">struct</span>

  <span class="Cmodule">module</span> <span class="Cconstructor">A</span> <span class="Cnonalphakeyword">=</span> <span class="Cstruct">struct</span>
    <span class="Ctype">type</span> char <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">X</span><span class="Cnonalphakeyword">.</span>t
    <span class="Ctype">type</span> t <span class="Cnonalphakeyword">=</span> <span class="Cconstructor">X</span><span class="Cnonalphakeyword">.</span>t array
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'a array -&gt; int">length</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'a array -&gt; int"><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>length</a>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'b array">empty</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'b array"><span class="Cnonalphakeyword">[|</span><span class="Cnonalphakeyword">|]</span></a>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'c -&gt; 'c array">singleton</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'c">l</a> <span class="Cnonalphakeyword">=</span> <span class="Cnonalphakeyword">[|</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="'c">l</a><span class="Cnonalphakeyword">|]</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'d array -&gt; 'd array -&gt; 'd array">append</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'d array -&gt; 'd array -&gt; 'd array"><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>append</a>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'e array -&gt; int -&gt; 'e">get</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'e array -&gt; int -&gt; 'e"><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>get</a>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'f array -&gt; int -&gt; int -&gt; 'f array">sub</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'f array -&gt; int -&gt; int -&gt; 'f array"><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>sub</a>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="('g -&gt; 'h) -&gt; 'g array -&gt; int -&gt; int -&gt; unit">iter_range</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'g -&gt; 'h">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'g array">a</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a> <span class="Cnonalphakeyword">=</span> <span class="Cfor">for</span> i <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a> <span class="Cto">to</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">ofs</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int"><span class="Cnonalphakeyword">+</span></a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">len</a><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; int -&gt; int">-1</a> <span class="Cdo">do</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'g -&gt; 'h">f</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="'g array">a</a><span class="Cnonalphakeyword">.</span><span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">i</a><span class="Cnonalphakeyword">)</span> <span class="Cdone">done</span>
    <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; X.t array -&gt; unit">print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="X.t array">a</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="(X.t -&gt; unit) -&gt; X.t array -&gt; unit"><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>iter</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter -&gt; X.t -&gt; unit"><span class="Cconstructor">X</span><span class="Cnonalphakeyword">.</span>print</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="Format.formatter">fmt</a><span class="Cnonalphakeyword">)</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="X.t array">a</a>
  <span class="Cend">end</span>

  <span class="Cmodule">module</span> <span class="Cconstructor">C</span> <span class="Cnonalphakeyword">=</span> <span class="Cstruct">struct</span> <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">small_length</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">256</a> <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">maximal_height</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">max_int</a> <span class="Cend">end</span>

  <span class="Cinclude">include</span> <span class="Cconstructor">Make</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">A</span><span class="Cnonalphakeyword">)</span><span class="Cnonalphakeyword">(</span><span class="Cconstructor">C</span><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="A.t -&gt; t">of_array</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="A.t -&gt; t">of_string</a>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; X.t -&gt; t">create</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="X.t">v</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="A.t -&gt; t">of_string</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; X.t -&gt; A.t"><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>create</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="X.t">v</a><span class="Cnonalphakeyword">)</span>

  <span class="Clet">let</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; (int -&gt; X.t) -&gt; t">init</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; X.t">f</a> <span class="Cnonalphakeyword">=</span> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="A.t -&gt; t">of_string</a> <span class="Cnonalphakeyword">(</span><a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; (int -&gt; X.t) -&gt; A.t"><span class="Cconstructor">Array</span><span class="Cnonalphakeyword">.</span>init</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int">n</a> <a href="javascript:;" style="text-decoration:none" class="Cannot" title="int -&gt; X.t">f</a><span class="Cnonalphakeyword">)</span>

<span class="Cend">end</span>

</pre>

<hr>
<p>
<em>This document was generated using 
<a href="http://martin.jambon.free.fr/caml2html.html">caml2html</a></em>
</body>
</html>
